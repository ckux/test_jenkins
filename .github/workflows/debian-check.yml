name: debianCheck
on: pull_request
  # pull_request:
    # paths-ignore:
    #   - ".github/workflows/**"
permissions:
  pull-requests: write
  contents: read
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_REPOSITORY: ${{ github.repository }}
  GITHUB_JOB: ${{ github.job }}
  GITHUB_WORKFLOW_SHA: ${{ github.workflow_sha }}
  PULL_NUMBER: ${{ github.event.pull_request.number }}
  GITHUB_REF_TYPE: ${{ github.ref_type }}
  EXCLUDE_FILES: "js,vue,ts,less,html,go,css,json,txt,doc,jpg,png,svg,py,yml,md"
  github_event: ${{ github.event }}
  github_event_name: ${{ github.event_name }}
  github.event_path: ${{ github.event_path }}
  github.graphql_url: ${{ github.graphql_url }}
  github.head_ref: ${{ github.head_ref }}
  github.path: ${{ github.path }}
  github.ref: ${{ github.ref }}
  github.ref_name: ${{ github.ref_name }}
  github.ref_type: ${{ github.ref_type }}
  github.sha$: ${{ github.sha }}
  github.token: ${{ github.token }}
  github.workflow_ref$: ${{ github.workflow_ref }}
  github.workflow_sha: ${{ github.workflow_sha }}

jobs:
  debian-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: '2'
      - name: Check Debian Prefix
        id: check-debian-prefix
        if: steps.checkout.outcome == 'success'
        run: |
          python3 $GITHUB_WORKSPACE/.github/script/debian-check.py --type pre-check
      - name: Check Specical Words
        id: check-specical-words
        if: steps.checkout.outcome == 'success' && always()
        env:
          FILTER_KEYS: "getcap,setcap,lshw,dmidecode"
        run: |
          python3 $GITHUB_WORKSPACE/.github/script/debian-check.py --type keys-check --keys $FILTER_KEYS --log keys.json
      - name: Check Env Set Words
        id: check-env-set-words
        if: steps.checkout.outcome == 'success' && always()
        env:
          FILTER_KEYS: "export,unset"
        run: |
          python3 $GITHUB_WORKSPACE/.github/script/debian-check.py --type keys-check --keys $FILTER_KEYS --log env-keys.json
      - name: Publish reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: my-artifact
          path: |
            keys.json
            env-keys.json
      - name: Comment PR
        if: always()
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: comment.txt
